---
title: "Visible Minority"
author: "Jens von Bergmann"
date: "`r Sys.Date()`"
output: html_notebook
vignette: >
  %\VignetteIndexEntry{Visible Minority}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Multi-category dot-density maps often work well when the categories cluster geographically. Visible minority data work well for this.
## Data
First we grab the immigrant data via [cancensus](https://github.com/mountainMath/cancensus), making use of the [CensusMapper API tool](https://censusmapper.ca/api/CA11) to select the regions and variables we need.
```{r, message=FALSE, warning=FALSE}
#devtools::install_github("mountainmath/cancensus")
library(cancensus)
library(dotdensity)
library(cancensusHelpers)
# options(cancensus.api_key='your_api_key')
regions=list(CMA="59933")
vectors=search_census_vectors("Total - Visible minority for the population in private households", "CA16","Total") %>% child_census_vectors(TRUE) %>% pull("vector")
```

We choose the categories and colours we want to map and define a convenience function to rename the variables and compute the qantities for the other asian countries that we don't break out.
```{r}
categories=c("South Asian", "Chinese", "Black", "Filipino", "Latin American", "Arab", "Southeast Asian", "West Asian", "Korean", "Japanese", "Visible minority, n.i.e.", "Multiple visible minorities", "Not a visible minority")
colors=c("#33a02c", "#e31a1c", "#b15928", "#1f78b4", "#fdbf6f", "#ff7f00", "#fb9a99", "#b2df8a", "#cab2d6", "#6a3d9a", "#a6cee3", "#ffff99", "#e0e0e0")

prep_data <- function(geo){
  data <- geo@data %>% replace(is.na(.), 0)
  geo@data <- data
  geo <- detail_labels(geo)
  return(geo)
}
```


Next we grab the data via `cancensus`,
```{r, echo=TRUE, message=FALSE, warning=FALSE}
data_csd=get_census(dataset = 'CA16', regions=regions,vectors=vectors,geo_format='sp',labels='short',level='CSD') %>% prep_data
data_ct=get_census(dataset = 'CA16', regions=regions,vectors=vectors,geo_format='sp',labels='short',level='CT') %>% prep_data
data_da=get_census(dataset = 'CA16', regions=regions,vectors=vectors,geo_format='sp',labels='short',level='DA') %>% prep_data
data_db=get_census(dataset = 'CA16', regions=regions,geo_format='sp',labels='short',level='DB')
```

which we then re-aggregate to make sure we don't miss overall counts due to privacy cutoffs distribute them
proportionally among the population.
```{r}
data_ct@data <- dot_density.proportional_re_aggregate(data=data_ct@data,parent_data=data_csd@data,geo_match=setNames("GeoUID","CSD_UID"),categories=categories,base="Population")
data_da@data <- dot_density.proportional_re_aggregate(data=data_da@data,parent_data=data_ct@data,geo_match=setNames("GeoUID","CT_UID"),categories=categories,base="Population")
data_db@data <- dot_density.proportional_re_aggregate(data=data_db@data,parent_data=data_da@data,geo_match=setNames("GeoUID","DA_UID"),categories=categories,base="Population")
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
bg_color="#111111"
base_color="#333333"
text_color="#eeeeee"
theme_opts<-list(theme(panel.grid.minor = element_blank(),
                       panel.grid.major = element_blank(),
                       panel.background = element_rect(fill = bg_color, colour = NA),
                       plot.background = element_rect(fill=bg_color, size=1,linetype="solid",color=text_color),
                       axis.line = element_blank(),
                       axis.text.x = element_blank(),
                       axis.text.y = element_blank(),
                       axis.ticks = element_blank(),
                       axis.title.x = element_blank(),
                       axis.title.y = element_blank(),
                       plot.title = element_text(size=70,hjust = 0.5, color=text_color),
                       plot.subtitle = element_text(size=50,hjust = 0.5, color=text_color),
                       plot.caption = element_text(size=25, color=text_color),
                       legend.title = element_text(size=14, color=text_color),
                       legend.text = element_text(size=14, color=text_color),
                       legend.background = element_rect(fill=bg_color, size=1,linetype="solid",color=bg_color),
                       legend.key = element_rect(fill = bg_color,color = bg_color),
                       legend.key.width = unit(3, 'lines'),
                       legend.position = "bottom"))

basemap <-   ggplot(data_csd) +
    geom_polygon(aes(long, lat, group = group), fill = base_color, size=0.1, color = 'grey') +
    guides(colour = guide_legend(nrow=1,override.aes = list(size=15))) +
    coord_map(projection="lambert", lat0=49, lat=49.4) +
    theme_opts

```


##Map
All that's left to do is to covert our re-aggregated block-level data to dots, using the `dot_density.compute_dots`
function from the [`dotdensity` package]() and feed it into the `dot_density.dots_map` function to add them to
our basemap.
```{r, fig.height=10, fig.width=13, message=TRUE, warning=TRUE}
# 1 dot = 5 immigrants
scale=25

tight_x <- c(-123.28857421875,-122.96310424804688)
tight_y <- c(49.16329776043147,49.347493514019895)
wide_x <-c(-123.29,-122.6)
wide_y <- c(49.02,49.35)
dots.db <- dot_density.compute_dots(geo_data = data_db, categories = categories, scale=scale)
basemap +
  # zoom in a bit
  coord_fixed(xlim=wide_x, ylim=wide_y, ratio = 1/cos(49.2/180*pi)) +
# shade unpopulated blocks
#  geom_polygon(data=data_db[data_db$Population<=5,], 
#                        aes(long, lat, group = group), 
#                        fill = "#222222", size=0.1, 
#                        color = "#222222") +
  scale_colour_manual(values = colors) +
  labs(color = "",
                title="Visible Minority 2016",
                caption="Source: StatCan Census 2016 via cancensus & CensusMapper.ca",
                subtitle = paste0("1 dot = ",scale," people")) + 
  dot_density.dots_map(dots=dots.db,alpha=0.75,size=0.25)

# save image for later
ggsave('../images/minority.png',width=26,height=26)
```
```{r}
scale=10
dots.db2 <- dot_density.compute_dots(geo_data = data_db, categories = categories, scale=scale)
basemap +
  # zoom in a bit
  coord_fixed(xlim=tight_x, ylim=tight_y, ratio = 1/cos(49.2/180*pi)) +
# shade unpopulated blocks
#  geom_polygon(data=data_db[data_db$Population<=5,], 
#                        aes(long, lat, group = group), 
#                        fill = "#222222", size=0.1, 
#                        color = "#222222") +
  scale_colour_manual(values = colors) +
  labs(color = "",
                title="Visible Minority 2016",
                caption="Source: StatCan Census 2016 via cancensus & CensusMapper.ca",
                subtitle = paste0("1 dot = ",scale," people")) + 
  dot_density.dots_map(dots=dots.db2,alpha=0.75,size=0.25)

# save image for later
ggsave('../images/minority_van.png',width=26,height=26)

```

